#!/bin/sh
set -e

# Allow callers to skip auto/config when configuration is already done.
if [ -n "${PHX_LB_SKIP_AUTO_CONFIG:-}" ]; then
  exit 0
fi

# Prevent recursive auto/config execution when lb config re-invokes auto/config.
SCRIPT_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
cd "$SCRIPT_DIR/.."
LOCK_FILE="$SCRIPT_DIR/.phx_lb_config_running"
if [ -n "${PHX_LB_CONFIG_RUNNING:-}" ] || [ -f "$LOCK_FILE" ]; then
  exit 0
fi
export PHX_LB_CONFIG_RUNNING=1
touch "$LOCK_FILE"

# Guard against lb config re-invoking auto/config.
if [ -n "${PHX_LB_CONFIG_GUARD:-}" ]; then
  exit 0
fi
export PHX_LB_CONFIG_GUARD=1
export PHX_LB_SKIP_AUTO_CONFIG=1

lb config \
  --mode ubuntu \
  --distribution noble \
  --architectures amd64 \
  --binary-images iso-hybrid \
  --archive-areas "main restricted universe multiverse" \
  --bootappend-live "boot=live components username=phoenix hostname=phoenix-15 locales=en_US.UTF-8 keyboard-layouts=us"
