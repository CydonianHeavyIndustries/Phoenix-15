#!/bin/sh
set -e

# Prevent recursive auto/config execution when lb config re-invokes auto/config.
SCRIPT_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
cd "$SCRIPT_DIR/.."
LOCK_FILE="$SCRIPT_DIR/.phx_lb_config_running"
if [ -n "${PHX_LB_CONFIG_RUNNING:-}" ] || [ -f "$LOCK_FILE" ]; then
  exit 0
fi
export PHX_LB_CONFIG_RUNNING=1
touch "$LOCK_FILE"
trap 'rm -f "$LOCK_FILE"' EXIT

lb config \
  --distribution bookworm \
  --architectures amd64 \
  --binary-images iso-hybrid \
  --archive-areas "main contrib non-free-firmware" \
  --debian-installer live \
  --bootappend-live "boot=live components username=phoenix hostname=phoenix-15 locales=en_US.UTF-8 keyboard-layouts=us"
